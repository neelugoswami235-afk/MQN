<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoodQuest | Privacy-First Mood Tracker</title>
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #a855f7;
            --bg: #0f172a;
            --card: #1e293b;
        }
        body {
            background-color: var(--bg);
            color: #f8fafc;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            overflow-x: hidden;
        }
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .mood-btn {
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .mood-btn:hover { transform: scale(1.15); }
        .mood-btn.active { 
            transform: scale(1.2);
            filter: drop-shadow(0 0 8px var(--primary));
        }
        .xp-bar {
            height: 8px;
            background: #334155;
            border-radius: 4px;
            overflow: hidden;
        }
        .xp-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.5s ease-out;
        }
        #auth-screen {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .hidden { display: none !important; }
        @keyframes bounce-in {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        .animate-pop { animation: bounce-in 0.5s ease-out forwards; }
    </style>
</head>
<body class="pb-20">

    <!-- Auth / PIN Screen -->
    <div id="auth-screen">
        <div class="max-w-xs w-full p-6 glass rounded-3xl text-center">
            <div class="mb-6">
                <i class="fas fa-shield-halved text-4xl text-indigo-400 mb-2"></i>
                <h2 id="auth-title" class="text-xl font-bold">Secure Access</h2>
                <p id="auth-subtitle" class="text-gray-400 text-sm">Enter PIN to unlock MoodQuest</p>
            </div>
            <div class="flex justify-center gap-3 mb-6" id="pin-dots">
                <div class="w-3 h-3 rounded-full bg-slate-700"></div>
                <div class="w-3 h-3 rounded-full bg-slate-700"></div>
                <div class="w-3 h-3 rounded-full bg-slate-700"></div>
                <div class="w-3 h-3 rounded-full bg-slate-700"></div>
            </div>
            <div class="grid grid-cols-3 gap-4" id="pin-pad">
                <!-- JS generated buttons -->
            </div>
            <button id="reset-data-btn" class="mt-8 text-xs text-red-400 underline opacity-50 hover:opacity-100">Forgot PIN / Reset All</button>
        </div>
    </div>

    <!-- Main Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 glass border-t border-slate-800 z-50 px-6 py-3">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <button onclick="showView('home')" class="nav-link text-indigo-400"><i class="fas fa-home text-xl"></i></button>
            <button onclick="showView('stats')" class="nav-link text-slate-400"><i class="fas fa-chart-line text-xl"></i></button>
            <button onclick="showView('quest')" class="nav-link text-slate-400"><i class="fas fa-dragon text-xl"></i></button>
            <button onclick="showView('profile')" class="nav-link text-slate-400"><i class="fas fa-user-shield text-xl"></i></button>
        </div>
    </nav>

    <!-- App Container -->
    <main class="max-w-md mx-auto p-6 space-y-6">
        
        <!-- Header / Level Info -->
        <header class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">MoodQuest</h1>
                <p class="text-slate-400 text-xs uppercase tracking-widest font-semibold" id="header-streak">0 Day Streak</p>
            </div>
            <div class="text-right">
                <span class="text-xs text-indigo-300 font-bold">LVL <span id="level-val">1</span></span>
                <div class="xp-bar w-24 mt-1">
                    <div id="xp-fill" class="xp-progress" style="width: 0%"></div>
                </div>
            </div>
        </header>

        <!-- View: Home -->
        <section id="view-home" class="space-y-6">
            <div class="glass p-6 rounded-3xl text-center">
                <h2 class="text-lg font-medium mb-4">How are you feeling?</h2>
                <div class="flex justify-between items-center mb-6">
                    <button class="mood-btn text-4xl filter grayscale hover:grayscale-0 transition" onclick="selectMood(1, 'üò¢')">üò¢</button>
                    <button class="mood-btn text-4xl filter grayscale hover:grayscale-0 transition" onclick="selectMood(2, 'üòï')">üòï</button>
                    <button class="mood-btn text-4xl filter grayscale hover:grayscale-0 transition" onclick="selectMood(3, 'üòê')">üòê</button>
                    <button class="mood-btn text-4xl filter grayscale hover:grayscale-0 transition" onclick="selectMood(4, 'üôÇ')">üôÇ</button>
                    <button class="mood-btn text-4xl filter grayscale hover:grayscale-0 transition" onclick="selectMood(5, 'ü§©')">ü§©</button>
                </div>
                <textarea id="mood-note" placeholder="Write a tiny note... (optional)" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none mb-4 h-20"></textarea>
                <button id="save-mood-btn" onclick="saveMood()" class="w-full bg-indigo-600 hover:bg-indigo-500 py-3 rounded-xl font-bold shadow-lg shadow-indigo-500/20 transition-all">Complete Daily Quest</button>
            </div>

            <div id="daily-missions" class="space-y-3">
                <h3 class="text-sm font-bold text-slate-400 px-1">DAILY MISSIONS</h3>
                <div id="mission-list" class="space-y-2">
                    <!-- Missions here -->
                </div>
            </div>
        </section>

        <!-- View: Stats -->
        <section id="view-stats" class="hidden space-y-6">
            <div class="glass p-6 rounded-3xl">
                <h2 class="text-lg font-bold mb-4">Mood Trends</h2>
                <div class="h-64">
                    <canvas id="moodChart"></canvas>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-6">
                    <div class="bg-slate-800/50 p-4 rounded-2xl text-center">
                        <p class="text-xs text-slate-400">Avg Mood</p>
                        <p class="text-2xl font-bold" id="avg-mood">-</p>
                    </div>
                    <div class="bg-slate-800/50 p-4 rounded-2xl text-center">
                        <p class="text-xs text-slate-400">Entries</p>
                        <p class="text-2xl font-bold" id="total-entries">0</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- View: Quest -->
        <section id="view-quest" class="hidden space-y-6">
            <div class="glass p-6 rounded-3xl">
                <h2 class="text-lg font-bold mb-4">Achievements</h2>
                <div class="grid grid-cols-3 gap-4" id="badges-grid">
                    <!-- Badges injected here -->
                </div>
            </div>
            
            <div id="badge-share-card" class="hidden glass p-6 rounded-3xl text-center border-2 border-indigo-500/30">
                <div id="capture-area" class="bg-gradient-to-br from-indigo-900 to-slate-900 p-8 rounded-2xl mb-4">
                    <div class="text-5xl mb-4" id="share-emoji">üèÜ</div>
                    <h3 class="text-xl font-bold" id="share-title">Title</h3>
                    <p class="text-indigo-300 text-sm" id="share-desc">Description</p>
                    <div class="mt-4 pt-4 border-t border-white/10 text-[10px] uppercase tracking-tighter opacity-50">Generated by MoodQuest</div>
                </div>
                <button onclick="downloadBadge()" class="bg-white text-slate-900 px-6 py-2 rounded-full font-bold text-sm">Download & Share</button>
            </div>
        </section>

        <!-- View: Profile/Settings -->
        <section id="view-profile" class="hidden space-y-6">
            <div class="glass p-6 rounded-3xl space-y-6">
                <div>
                    <h2 class="text-lg font-bold mb-2">Privacy & Data</h2>
                    <p class="text-sm text-slate-400">All data stays in your browser's IndexedDB.</p>
                </div>
                
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <label class="text-sm">Analytics (Opt-in)</label>
                        <input type="checkbox" id="analytics-toggle" class="w-5 h-5 accent-indigo-500">
                    </div>
                    
                    <button onclick="exportData()" class="w-full bg-slate-700 py-3 rounded-xl font-medium text-sm">Export JSON Backup</button>
                    
                    <div>
                        <label class="block text-xs text-slate-500 mb-1">Restore from Backup</label>
                        <input type="file" id="import-file" onchange="importData(event)" class="text-xs block w-full text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    </div>
                    
                    <button onclick="changePin()" class="w-full border border-slate-700 py-3 rounded-xl font-medium text-sm">Change PIN</button>
                    <button onclick="logout()" class="w-full text-red-400 text-sm font-medium">Lock Session</button>
                </div>
            </div>
        </section>

    </main>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 px-6 py-3 glass rounded-full text-sm font-medium transition-all transform translate-y-[-100px] opacity-0 z-[60]"></div>

    <script>
        /** * APP CONSTANTS & STATE 
         */
        const DB_NAME = 'MoodQuestDB';
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'moodquest-local';
        let currentUser = null;
        let selectedMoodValue = 0;
        let chartInstance = null;
        let pinBuffer = "";
        let isSettingNewPin = false;

        /**
         * INDEXED DB WRAPPER
         */
        const dbPromise = new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, 2);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('logs')) {
                    db.createObjectStore('logs', { keyPath: 'id', autoIncrement: true });
                }
                if (!db.objectStoreNames.contains('profile')) {
                    db.createObjectStore('profile', { keyPath: 'id' });
                }
            };
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });

        const store = {
            async get(name, key) {
                const db = await dbPromise;
                return new Promise(res => {
                    const req = db.transaction(name).objectStore(name).get(key);
                    req.onsuccess = () => res(req.result);
                });
            },
            async getAll(name) {
                const db = await dbPromise;
                return new Promise(res => {
                    const req = db.transaction(name).objectStore(name).getAll();
                    req.onsuccess = () => res(req.result);
                });
            },
            async put(name, val) {
                const db = await dbPromise;
                return new Promise(res => {
                    const tx = db.transaction(name, 'readwrite');
                    tx.objectStore(name).put(val);
                    tx.oncomplete = () => res();
                });
            },
            async clear(name) {
                const db = await dbPromise;
                return new Promise(res => {
                    const tx = db.transaction(name, 'readwrite');
                    tx.objectStore(name).clear();
                    tx.oncomplete = () => res();
                });
            }
        };

        /**
         * CRYPTO HELPER (PIN Protection)
         */
        async function hashPin(pin, salt) {
            const encoder = new TextEncoder();
            const data = encoder.encode(pin + salt);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode(...new Uint8Array(hash)));
        }

        /**
         * GAMIFICATION ENGINE
         */
        const QUEST = {
            getXPForLevel: (lvl) => Math.floor(100 * Math.pow(1.5, lvl - 1)),
            calculateProgress: (currentXP, level) => {
                const prevXP = level === 1 ? 0 : QUEST.getXPForLevel(level - 1);
                const nextXP = QUEST.getXPForLevel(level);
                return Math.max(0, Math.min(100, ((currentXP - prevXP) / (nextXP - prevXP)) * 100));
            },
            checkLevelUp: (user) => {
                let currentLevel = user.level;
                while (user.xp >= QUEST.getXPForLevel(currentLevel)) {
                    currentLevel++;
                }
                return currentLevel;
            },
            BADGES: [
                { id: 'first_step', title: 'First Step', desc: 'Log your first mood', emoji: 'üå±', req: (u, logs) => logs.length >= 1 },
                { id: 'three_streak', title: 'Consistent', desc: 'Maintain a 3-day streak', emoji: 'üî•', req: (u) => u.streak >= 3 },
                { id: 'level_5', title: 'Apprentice', desc: 'Reach Level 5', emoji: 'üõ°Ô∏è', req: (u) => u.level >= 5 },
                { id: 'night_owl', title: 'Night Owl', desc: 'Log after 10 PM', emoji: 'ü¶â', req: (u, logs) => logs.some(l => new Date(l.timestamp).getHours() >= 22) }
            ]
        };

        /**
         * UI CONTROLS
         */
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.remove('opacity-0', 'translate-y-[-100px]');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-[-100px]'), 3000);
        }

        function showView(view) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.replace('text-indigo-400', 'text-slate-400'));
            
            // Fixed event referencing
            const target = event ? event.currentTarget : document.querySelector(`[onclick="showView('${view}')"]`);
            if (target) target.classList.replace('text-slate-400', 'text-indigo-400');
            
            if (view === 'stats') renderChart();
            if (view === 'quest') renderQuests();
        }

        /**
         * AUTH & PIN LOGIC
         */
        async function initAuth() {
            const profile = await store.get('profile', 'main');
            const pinPad = document.getElementById('pin-pad');
            pinPad.innerHTML = "";
            
            [1, 2, 3, 4, 5, 6, 7, 8, 9, 'C', 0, '‚Üê'].forEach(val => {
                const btn = document.createElement('button');
                btn.className = "p-4 glass rounded-2xl font-bold text-xl hover:bg-slate-700 transition active:scale-95";
                btn.textContent = val;
                btn.onclick = () => handlePinInput(val);
                pinPad.appendChild(btn);
            });

            if (!profile) {
                isSettingNewPin = true;
                document.getElementById('auth-title').textContent = "Set Your PIN";
                document.getElementById('auth-subtitle').textContent = "Pick a 4-digit code to keep logs private.";
            }
        }

        async function handlePinInput(val) {
            if (val === 'C') pinBuffer = "";
            else if (val === '‚Üê') pinBuffer = pinBuffer.slice(0, -1);
            else if (pinBuffer.length < 4) pinBuffer += val;

            const dots = document.getElementById('pin-dots').children;
            for (let i = 0; i < 4; i++) {
                dots[i].className = i < pinBuffer.length ? "w-3 h-3 rounded-full bg-indigo-400 shadow-[0_0_8px_#818cf8]" : "w-3 h-3 rounded-full bg-slate-700";
            }

            if (pinBuffer.length === 4) {
                setTimeout(verifyPin, 200);
            }
        }

        async function verifyPin() {
            const profile = await store.get('profile', 'main');
            
            if (isSettingNewPin) {
                const salt = crypto.randomUUID();
                const hash = await hashPin(pinBuffer, salt);
                const newUser = {
                    id: 'main',
                    pinHash: hash,
                    salt: salt,
                    level: 1,
                    xp: 0,
                    streak: 0,
                    lastLogDate: null,
                    badges: [],
                    analytics: false
                };
                await store.put('profile', newUser);
                currentUser = newUser;
                unlockApp();
                showToast("Welcome to MoodQuest!");
            } else {
                const hash = await hashPin(pinBuffer, profile.salt);
                if (hash === profile.pinHash) {
                    currentUser = profile;
                    unlockApp();
                } else {
                    showToast("Incorrect PIN");
                    pinBuffer = "";
                    const dots = document.getElementById('pin-dots').children;
                    for(let d of dots) d.className = "w-3 h-3 rounded-full bg-red-500";
                    setTimeout(() => {
                        for(let d of dots) d.className = "w-3 h-3 rounded-full bg-slate-700";
                    }, 500);
                }
            }
        }

        function unlockApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            updateUserUI();
            checkDailyStatus();
        }

        function logout() {
            location.reload();
        }

        /**
         * CORE APP LOGIC
         */
        function selectMood(val, emoji) {
            selectedMoodValue = val;
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === emoji);
                btn.classList.toggle('grayscale-0', btn.textContent === emoji);
            });
        }

        async function saveMood() {
            if (selectedMoodValue === 0) return showToast("Select a mood first!");
            
            const logs = await store.getAll('logs');
            const today = new Date().toDateString();
            if (logs.some(l => new Date(l.timestamp).toDateString() === today)) {
                return showToast("Already quested today!");
            }

            const note = document.getElementById('mood-note').value;
            const newLog = {
                timestamp: Date.now(),
                value: selectedMoodValue,
                note: note
            };

            await store.put('logs', newLog);
            
            // Gamification Update
            let xpGained = 10;
            const lastDate = currentUser.lastLogDate ? new Date(currentUser.lastLogDate).toDateString() : null;
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);

            if (lastDate === yesterday.toDateString()) {
                currentUser.streak++;
                xpGained += Math.min(20, currentUser.streak * 2); // Streak bonus
            } else if (lastDate !== today) {
                currentUser.streak = 1;
            }

            currentUser.xp += xpGained;
            currentUser.lastLogDate = Date.now();
            
            const newLevel = QUEST.checkLevelUp(currentUser);
            if (newLevel > currentUser.level) {
                currentUser.level = newLevel;
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                showToast(`Level Up! You are now LVL ${newLevel}`);
            }

            // Check badges
            const currentLogs = await store.getAll('logs');
            QUEST.BADGES.forEach(b => {
                if (!currentUser.badges.includes(b.id) && b.req(currentUser, currentLogs)) {
                    currentUser.badges.push(b.id);
                    showToast(`Unlocked Badge: ${b.title}!`);
                }
            });

            await store.put('profile', currentUser);
            updateUserUI();
            showToast(`Mood logged! +${xpGained} XP`);
            
            // Clear inputs
            selectedMoodValue = 0;
            document.getElementById('mood-note').value = "";
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.classList.remove('active', 'grayscale-0');
            });
            checkDailyStatus();
        }

        async function updateUserUI() {
            document.getElementById('level-val').textContent = currentUser.level;
            document.getElementById('header-streak').textContent = `${currentUser.streak} Day Streak`;
            const progress = QUEST.calculateProgress(currentUser.xp, currentUser.level);
            document.getElementById('xp-fill').style.width = `${progress}%`;
            document.getElementById('analytics-toggle').checked = currentUser.analytics;
        }

        async function checkDailyStatus() {
            const logs = await store.getAll('logs');
            const today = new Date().toDateString();
            const done = logs.some(l => new Date(l.timestamp).toDateString() === today);
            
            const btn = document.getElementById('save-mood-btn');
            if (done) {
                btn.disabled = true;
                btn.textContent = "Daily Quest Complete ‚úì";
                btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-500');
                btn.classList.add('bg-emerald-600');
            } else {
                btn.disabled = false;
                btn.textContent = "Complete Daily Quest";
                btn.classList.add('bg-indigo-600', 'hover:bg-indigo-500');
                btn.classList.remove('bg-emerald-600');
            }

            const mList = document.getElementById('mission-list');
            mList.innerHTML = `
                <div class="glass p-4 rounded-2xl flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full ${done ? 'bg-emerald-500/20 text-emerald-400' : 'bg-slate-700 text-slate-500'} flex items-center justify-center">
                            <i class="fas fa-check text-xs"></i>
                        </div>
                        <span class="text-sm font-medium">Daily Reflection</span>
                    </div>
                    <span class="text-xs font-bold text-indigo-400">+10 XP</span>
                </div>
            `;
        }

        /**
         * CHARTS
         */
        async function renderChart() {
            const logs = await store.getAll('logs');
            const recent = logs.slice(-7);
            const canvas = document.getElementById('moodChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            if (chartInstance) chartInstance.destroy();

            // Stats update
            const total = logs.length;
            const avg = total > 0 ? (logs.reduce((acc, curr) => acc + curr.value, 0) / total).toFixed(1) : '-';
            document.getElementById('total-entries').textContent = total;
            document.getElementById('avg-mood').textContent = avg;

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: recent.map(l => new Date(l.timestamp).toLocaleDateString(undefined, {weekday: 'short'})),
                    datasets: [{
                        label: 'Mood Level',
                        data: recent.map(l => l.value),
                        borderColor: '#818cf8',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#818cf8',
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { min: 1, max: 5, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { stepSize: 1 } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        /**
         * BADGES & SHARING
         */
        async function renderQuests() {
            const grid = document.getElementById('badges-grid');
            grid.innerHTML = "";
            
            QUEST.BADGES.forEach(b => {
                const unlocked = currentUser.badges.includes(b.id);
                const el = document.createElement('div');
                el.className = `p-4 glass rounded-2xl text-center cursor-pointer transition ${unlocked ? 'opacity-100 hover:scale-105' : 'opacity-30'}`;
                el.innerHTML = `
                    <div class="text-3xl mb-1">${b.emoji}</div>
                    <p class="text-[10px] font-bold uppercase truncate">${b.title}</p>
                `;
                if (unlocked) {
                    el.onclick = () => previewBadge(b);
                }
                grid.appendChild(el);
            });
        }

        function previewBadge(badge) {
            const card = document.getElementById('badge-share-card');
            card.classList.remove('hidden');
            document.getElementById('share-emoji').textContent = badge.emoji;
            document.getElementById('share-title').textContent = badge.title;
            document.getElementById('share-desc').textContent = badge.desc;
            card.scrollIntoView({ behavior: 'smooth' });
        }

        async function downloadBadge() {
            const element = document.getElementById('capture-area');
            const canvas = await html2canvas(element, { backgroundColor: null });
            const link = document.createElement('a');
            link.download = `MoodQuest-Badge-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            showToast("Badge downloaded!");
        }

        /**
         * DATA MANAGEMENT
         */
        async function exportData() {
            const logs = await store.getAll('logs');
            const data = {
                profile: currentUser,
                logs: logs,
                exportedAt: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `moodquest-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (!data.profile || !data.logs) throw new Error("Invalid format");
                    
                    await store.put('profile', data.profile);
                    await store.clear('logs');
                    for (let log of data.logs) {
                        await store.put('logs', log);
                    }
                    showToast("Data restored successfully! Restarting...");
                    setTimeout(() => location.reload(), 2000);
                } catch (err) {
                    showToast("Error importing data.");
                }
            };
            reader.readAsText(file);
        }

        async function changePin() {
            isSettingNewPin = true;
            pinBuffer = "";
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('auth-title').textContent = "Set New PIN";
            initAuth();
        }

        // Reset Data flow
        document.getElementById('reset-data-btn').onclick = async () => {
            if (confirm("THIS WILL WIPE EVERYTHING. Are you sure?")) {
                await store.clear('profile');
                await store.clear('logs');
                location.reload();
            }
        };

        // Initialize App
        window.onload = initAuth;

        // PWA functionality (Disabled Service Worker registration due to restricted sandbox protocol support)
        // In a standard hosting environment (Netlify/Vercel), you would use:
        // navigator.serviceWorker.register('/sw.js');
    </script>
</body>
</html>
